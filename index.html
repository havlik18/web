<p style="color:#0a66c2">Test: stránka se načetla.</p>
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reporty dodavatelů — Lukáš Havel</title>

  <!-- Jednoduché styly -->
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; margin: 24px; line-height: 1.6; }
    h1 { font-size: 24px; margin: 0 0 8px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .row { grid-template-columns: 300px 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 16px; background: rgba(255,255,255,0.7); }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    select, input[type="file"] { width: 100%; padding: 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; font-size: 14px; }
    tfoot td { font-weight: 700; }
    .muted { color: #666; font-size: 13px; }
    canvas { background: rgba(255,255,255,0.7); border: 1px solid #ddd; border-radius: 10px; }
    .error { color: #b00020; }
  </style>

  <!-- SheetJS pro načtení Excelu (XLS/XLSX) — CDN -->
  <script src="vendor/xlsx.full.min.js  <!-- Chart.js pro grafy — CDN -->
  <script src="vendor/chart.umd.min.j</script>
</head>
<body>
  <header style="margin-bottom:16px">
    <h1>Reporty dodavatelů</h1>
    <p class="muted">Nahraj Excel (.xls nebo .xlsx) se sloupci: A&nbsp;= Dodavatel, B&nbsp;= Datum, C&nbsp;= Počet zásilek, D&nbsp;= Obrat.</p>
  </header>

  <div class="row">
    <!-- Ovládací panel -->
    <aside class="card">
      <div style="margin-bottom:12px">
        <label for="file">1) Nahrát Excel soubor</label>
        <input type="file" id="file" accept=".xls,.xlsx" />
        <div id="fileInfo" class="muted" style="margin-top:6px"></div>
        <div id="error" class="error" style="margin-top:6px"></div>
      </div>

      <div style="margin-bottom:12px">
        <label for="supplier">2) Vyber dodavatele</label>
        <select id="supplier" disabled>
          <option value="" selected>— nejprve nahraj soubor —</option>
        </select>
      </div>

      <div style="margin-bottom:12px">
        <label for="metric">3) Zobrazit metriky</label>
        <select id="metric">
          <option value="both" selected>Počet zásilek + Obrat</option>
          <option value="shipments">Pouze počet zásilek</option>
          <option value="revenue">Pouze obrat</option>
        </select>
      </div>

      <p class="muted">Tip: Pokud první řádek v Excelu obsahuje hlavičky, detekujeme je a vynecháme automaticky.</p>
    </aside>

    <!-- Data + graf -->
    <main class="card">
      <section>
        <h2 style="margin:0 0 10px">Graf dodavatele</h2>
        <canvas id="chart" height="120"></canvas>
      </section>

      <section style="margin-top:16px">
        <h2 style="margin:0 0 10px">Tabulka dat</h2>
        <div class="muted" id="tableInfo"></div>
        <table id="table">
          <thead>
            <tr>
              <th>Dodavatel</th>
              <th>Datum</th>
              <th>Počet zásilek</th>
              <th>Obrat</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="2">Součet</td>
              <td id="sumShipments">0</td>
              <td id="sumRevenue">0</td>
            </tr>
          </tfoot>
        </table>
      </section>
    </main>
  </div>

  <footer style="margin-top:20px" class="muted">
    © <span id="year"></span> Lukáš Havel
  </footer>

  <script>
    // Pomocné formátování čísel
    const fmtInt = new Intl.NumberFormat('cs-CZ', { maximumFractionDigits: 0 });
    const fmtCZK = new Intl.NumberFormat('cs-CZ', { style: 'currency', currency: 'CZK' });

    // Data držíme v paměti po nahrání souboru
    let allRows = [];      // každý řádek: { supplier, date: Date, shipments: number, revenue: number }
    let suppliers = [];    // unikátní názvy

    // Graf (Chart.js instance)
    let chart;

    // Excel -> Date (když přijde Excel serial číslo)
    function excelSerialToDate(serial) {
      // Excel datový serial => UTC date (offset 25569 dní od 1970-01-01)
      // Funguje pro moderní data, není třeba řešit 1900 leap bug.
      const utcDays = serial - 25569;
      return new Date(utcDays * 86400 * 1000);
    }

    // Parsování nahraného souboru
    document.getElementById('file').addEventListener('change', async (e) => {
      resetUI();
      const file = e.target.files?.[0];
      if (!file) return;

      document.getElementById('fileInfo').textContent = `Soubor: ${file.name} (${fmtInt.format(file.size)} B)`;

      try {
        const arrayBuffer = await file.arrayBuffer();
        // SheetJS: přečíst workbook (vč. XLS) — v prohlížeči
        const wb = XLSX.read(arrayBuffer, { type: 'array', cellDates: true });
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];

        // Vytáhnout data jako pole řádků (header:1 -> každá řádka je pole hodnot)
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });

        // Zpracování: A= dodavatel, B= datum, C= zásilky, D= obrat
        // Detekce hlavičky: pokud první řádek "nevypadá" jako data, přeskočíme jej.
        const startIdx = detectHeaderStart(rows);

        allRows = [];
        for (let i = startIdx; i < rows.length; i++) {
          const r = rows[i];
          if (!r || r.length < 4) continue;
          const supplier = String(r[0]).trim();
          let dateVal = r[1];
          let shipments = Number(r[2]);
          let revenue = Number(r[3]);

          // Datum může být string nebo excel serial číslo
          let date;
          if (dateVal instanceof Date) {
            date = dateVal;
          } else if (typeof dateVal === 'number') {
            date = excelSerialToDate(dateVal);
          } else if (typeof dateVal === 'string') {
            date = new Date(dateVal);
          }

          // Validace minimálně: dodavatel + datum
          if (!supplier || isNaN(date?.getTime())) continue;

          // Opravit NaN na 0
          shipments = isNaN(shipments) ? 0 : shipments;
          revenue = isNaN(revenue) ? 0 : revenue;

          allRows.push({ supplier, date, shipments, revenue });
        }

        // Seřadit podle data
        allRows.sort((a, b) => a.date - b.date);

        // Unikátní seznam dodavatelů
        suppliers = Array.from(new Set(allRows.map(r => r.supplier))).sort((a, b) => a.localeCompare(b, 'cs'));

        // Naplnit select
        const sel = document.getElementById('supplier');
        sel.innerHTML = '<option value="">— vyber —</option>' + suppliers.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');
        sel.disabled = suppliers.length === 0;

        document.getElementById('tableInfo').textContent = `Načteno řádků: ${fmtInt.format(allRows.length)} · Dodavatelů: ${fmtInt.format(suppliers.length)} · List: ${sheetName}`;

      } catch (err) {
        console.error(err);
        document.getElementById('error').textContent = 'Nepodařilo se načíst soubor. Zkontroluj, že jde o XLS/XLSX s požadovanými sloupci.';
      }
    });

    // Po změně dodavatele nebo metriky vykreslit tabulku a graf
    document.getElementById('supplier').addEventListener('change', renderView);
    document.getElementById('metric').addEventListener('change', renderView);

    function renderView() {
      const supplier = document.getElementById('supplier').value;
      if (!supplier) return;

      // Filtrovaná data dodavatele
      const rows = allRows.filter(r => r.supplier === supplier);

      // Tabulka
      const tbody = document.querySelector('#table tbody');
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.supplier)}</td>
          <td>${toISO(r.date)}</td>
          <td style="text-align:right">${fmtInt.format(r.shipments)}</td>
          <td style="text-align:right">${fmtCZK.format(r.revenue)}</td>
        </tr>
      `).join('');

      // Součty
      const sumShipments = rows.reduce((acc, r) => acc + r.shipments, 0);
      const sumRevenue = rows.reduce((acc, r) => acc + r.revenue, 0);
      document.getElementById('sumShipments').textContent = fmtInt.format(sumShipments);
      document.getElementById('sumRevenue').textContent = fmtCZK.format(sumRevenue);

      // Agregace po dnech (stejné datum -> součet)
      const byDateMap = new Map(); // key: YYYY-MM-DD
      for (const r of rows) {
        const d = toISO(r.date);
        const prev = byDateMap.get(d) || { shipments: 0, revenue: 0 };
        prev.shipments += r.shipments;
        prev.revenue += r.revenue;
        byDateMap.set(d, prev);
      }
      const labels = Array.from(byDateMap.keys()).sort();
      const seriesShip = labels.map(d => byDateMap.get(d).shipments);
      const seriesRev = labels.map(d => byDateMap.get(d).revenue);

      // Graf
      const metric = document.getElementById('metric').value;
      const datasets = [];
      if (metric === 'both' || metric === 'shipments') {
        datasets.push({
          label: 'Počet zásilek',
          data: seriesShip,
          borderColor: '#0a66c2',
          backgroundColor: 'rgba(10,102,194,0.15)',
          tension: 0.2,
          yAxisID: 'yShip'
        });
      }
      if (metric === 'both' || metric === 'revenue') {
        datasets.push({
          label: 'Obrat (Kč)',
          data: seriesRev,
          borderColor: '#ff7f0e',
          backgroundColor: 'rgba(255,127,14,0.15)',
          tension: 0.2,
          yAxisID: 'yRev'
        });
      }

      const ctx = document.getElementById('chart');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: (item) => {
                  if (item.dataset.label.includes('Obrat')) {
                    return `${item.dataset.label}: ${fmtCZK.format(item.parsed.y)}`;
                  }
                  return `${item.dataset.label}: ${fmtInt.format(item.parsed.y)}`;
                }
              }
            }
          },
          scales: {
            x: { title: { text: 'Datum', display: true } },
            yShip: {
              type: 'linear',
              position: 'left',
              title: { text: 'Počet zásilek', display: true },
              grid: { drawOnChartArea: true }
            },
            yRev: {
              type: 'linear',
              position: 'right',
              title: { text: 'Obrat (Kč)', display: true },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });
    }

    // Detekce přítomnosti hlavičky v prvním řádku
    function detectHeaderStart(rows) {
      if (!rows.length) return 0;
      const first = rows[0];
      // Pokud třetí/čtvrtý sloupec nejsou čísla, pravděpodobně jde o hlavičku
      const looksHeader =
        first &&
        first.length >= 4 &&
        (typeof first[2] !== 'number' || typeof first[3] !== 'number');
      return looksHeader ? 1 : 0;
    }

    // Pomocné funkce
    function toISO(d) {
      // YYYY-MM-DD
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
    function resetUI() {
      document.getElementById('error').textContent = '';
      document.getElementById('supplier').innerHTML = '<option value="">— vyber —</option>';
      document.getElementById('supplier').disabled = true;
      document.querySelector('#table tbody').innerHTML = '';
      document.getElementById('sumShipments').textContent = '0';
      document.getElementById('sumRevenue').textContent = fmtCZK.format(0);
      if (chart) { chart.destroy(); chart = null; }
    }

    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>


